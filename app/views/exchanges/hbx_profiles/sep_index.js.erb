set_tab_content("<%= escape_javascript render "sep/index"%>")
$('.sep_link').hide();
$('.admin_effective_on_kind_options').hide();
$('.init_event_date').hide();

var ivlTable, shopTable, ivl_shop_Table, selectedTable;
var history_btn_counter = 0;
var add_btn_counter = 0;
var tab_counter = 0;

var columnVal = [
                  { targets: [6,7], orderable: false},
                  { targets: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18], visible: false}
                ];

$(document).ready(function() {

  ivl_shop_Table = $('#sepAdmin').DataTable( {
      columnDefs: columnVal,
      "order": [[ 2, "asc" ]]
    } );
   
  ivlTable = $('#sepAdmin1').DataTable( {
      columnDefs: columnVal,
      "order": [[ 2, "asc" ]]
    } );

  shopTable = $('#sepAdmin2').DataTable( {
      columnDefs: columnVal,
      "order": [[ 2, "asc" ]]
    } );

  });

$(document).on('change','.admin_selected_sep_reason select',function(){  
  if($(this).val() == '') {
   $('.init_event_date').hide();    
   $('.admin_effective_on_kind_options').hide();
  }
  else{
   $('.init_event_date input').val("");
   $('.init_event_date').show();
   $('.admin_effective_on_kind_options').hide();
  }
});

$(document).on('change','.init_event_date input', function(){
  if($(this).val() == ''){
   $('.admin_effective_on_kind_options').hide(); 
  }
  else{
   $('.admin_effective_on_kind_options select').val('');
   $('.admin_effective_on_kind_options').show();
   $('select.selectric').selectric();

   $('input.floatlabel').floatlabel({
      slideInput: false
   });
  }  
});

$('#tab_datatables a[data-toggle="tab"]').on("click", function(){

  switch($(this).attr('data-target')) {
    case '#ivl_shop_Table':   
      selectedTable = ivl_shop_Table; 
      break;
    case '#ivlTable':
      resetButtons($('td.history-control'))
      $('#sep_table tbody td.add-control').trigger("click");
      selectedTable = ivlTable; 
      break;
    case '#shopTable':   
      selectedTable = shopTable;
      break;
    }  

  });

$('.sep_table tbody').on('click', 'td.add-control', function () {
  var btn_class = $(this).attr("class");
  var tr = $(this).closest('tr');
  var row = selectedTable.row(tr);
  var builder = row.data()[10];

  if (row.child.isShown() ) {
    add_btn_counter--;
    $(this).removeClass('fa fa-minus-square');
    $(this).find('i').addClass('fa fa-plus-square');
    
    add_btn_counter == 0 ? resetButtons($('td.history-control')) : add_btn_counter;
    
    $('div.add_sep_datatable_slider', row.child()).slideUp( function () {
    row.child.hide();
   });
  }
  
  else {
      
     
        add_btn_counter++;
        $(this).find('i').removeClass('fa fa-plus-square');
        $(this).addClass('fa fa-minus-square');
        $('td.history-control').prop('disabled', true);
        $('td.history-control').removeClass('icon_enabled');
        $('td.history-control').addClass('icon_disabled');
        $('td.history-control').css("cursor", "default");

      //Open this row
        row.child(displayTable(builder, btn_class, ""), 'no-padding' ).show();
        $('select.selectric').selectric();
        $('input.floatlabel').floatlabel({
          slideInput: false
        });

        $('select.floatlabel').floatlabel({
          slideInput: false
        });

        $('div.add_sep_datatable_slider', row.child()).slideDown();
      }
});


$('.sep_table tbody').on('click', 'td.history-control', function () {
  var btn_class = $(this).attr("class");
  var tr = $(this).closest('tr');
  var row = selectedTable.row(tr)
  var reason = row.data()[8].split("?dummyData");
  var admin_comment = row.data()[9].split("?dummyData");
  var fullName = row.data()[1] + " " + row.data()[2];
  var csl = row.data()[11].split("?dummyData");
  var effective_on_kind = row.data()[12].split("?dummyData");
  var start_on = row.data()[13].split("?dummyData");
  var end_on = row.data()[14].split("?dummyData");
  var event_date = row.data()[15].split("?dummyData");
  var next_poss_date = row.data()[16].split("?dummyData");
  var medical = row.data()[17];
  var dental = row.data()[18];

  var builder = buildTable(reason.length-1, reason, admin_comment, csl, effective_on_kind, start_on, end_on, event_date, next_poss_date, medical, dental);

  if ( row.child.isShown() ) {
    history_btn_counter--;
    $(this).removeClass('fa fa-folder-open');
    $(this).find('i').addClass('fa fa-folder');
    
    history_btn_counter == 0 ? resetButtons($('td.add-control')) : history_btn_counter;
  // This row is already open - close it
    $('div.add_sep_datatable_slider', row.child()).slideUp( function () {
    row.child.hide();

    $('.admin_effective_on_kind_options').hide();
    //tr.removeClass('shown');
    } );
  }
  
  else {
    history_btn_counter++;
    $(this).find('i').removeClass('fa fa-folder');
    $(this).addClass('fa fa-folder-open');
    $('td.add-control').prop('disabled', true);
    $('td.add-control').removeClass('icon_enabled');
    $('td.add-control').addClass('icon_disabled');
    $('td.add-control').css("cursor", "default");

  // Open this row
    row.child(displayTable(builder, btn_class, fullName), 'no-padding' ).show();
    $('select.selectric').selectric();

    $('div.add_sep_datatable_slider', row.child()).slideDown();
  }
  }
);

 $(".btn").click(function() {
    if($("#collapseme").hasClass("out")) {
        $("#collapseme").addClass("in");
        $("#collapseme").removeClass("out");
    } else {
        $("#collapseme").addClass("out");
        $("#collapseme").removeClass("in");
    }
});

  //$( '#tab_datatables a[data-toggle="tab"]:last').trigger("click");
$( '#tab_datatables a[data-toggle="tab"]:first').trigger("click");
  

function resetButtons(button){
  button.prop('disabled', false);
  button.removeClass('icon_disabled');
  button.addClass('icon_enabled');
  button.css("cursor", "pointer");
}

function displayTable(custom_table, className, name) {

    if (className == 'add-control'){

      return '<div class="add_sep_datatable_slider" style="display:none">'+
            '<div class="row container">' +
            custom_table + 
            '<br/>'+
            '</div>' +
            '</div>';
    }

    else {

      return '<br/>' + '<br/>' + 
              '<div class="add_sep_datatable_slider" style="display:none">'+
              '<h3>' + name + '</h3>' +
        
              '<div class = "table-responsive">' + 
                '<table class = "table table-striped table-bordered">'+
                    custom_table + 
                '</table>'+
              '</div>' + 
              '<br/>'+ 
            '</div>';
    }
}


 function buildTable(size, reason, admin_comment, csl, effective_on_kind, start_on, end_on, event_date, next_poss_date, medical, dental)
 {
    var val = "";
    var comment_section;

    for(i=size-1; i>=0; i--){

      if(admin_comment[i] == "")
        comment_section = 'Admin Comment: N/A';
      else
        comment_section = 'Admin Comment: ' + admin_comment[i];

      val =   val + 
                '<tr>'+
                '<th>SEP REASON</th>'+ 
                '<th>EFFECTIVE DATE RULE</th>'+ 
                '<th>EVENT DATE</th>'+
                '<th>SEP START DATE</th>'+
                '<th>SEP END DATE</th>'+
                '<th>NEXT POSSIBLE EVENT DATE</th>'+
                '<th>CHOICE DATE 1</th>'+
                '<th>CHOICE DATE 2</th>'+
                '<th>CHOICE DATE 3</th>'+
                '<th>CSL#</th>'+
                //'<th>MEDICAL</th>'+
                //'<th>DENTAL</th>'+
                //'<th>MEDICAL</th>'+
                //'<th>DENTAL</th>'+
                //'<th>Selected Date</th>'+
                //'<th>Effective Date</th>'+
                //'<th>Selected Date</th>'+
                //'<th>Effective Date</th>'+
                //'<th style="text-align:center";>Review Status</th>'+
                '</tr>'+
              '</thead>'+
        
              '<tbody>'+
                '<tr>'+
                  '<td>' + reason[i] + '</td>'+
                  '<td>' + effective_on_kind[i].replace(/_/g, " ") + '</td>'+
                  '<td>' + event_date[i] + '</td>'+
                  '<td>' + start_on[i] + '</td>'+
                  '<td>' + end_on[i] + '</td>'+
                  '<td>' + next_poss_date[i] + '</td>'+
                  '<td></td>'
                  '<td></td>'
                  '<td></td>'
                  '<td>' + csl[i] + '</td>'+
                  //'<td>' + medical + '</td>'+
                  //'<td>' + dental + '</td>'+
                  //'<td>' + medical + '</td>'+
                  //'<td>' + dental + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td></td>'+
                  //'<td style="text-align:center";><i class="fa fa-spinner fa-spin" style="color:grey"></i></td>'+
                '</tr>'+ 


                '<tr>' +
                   '<td>&nbsp;&nbsp;' + comment_section + '</td>' +
                '</tr>'+
              '</tbody>' 
    }

    return val;
 }





