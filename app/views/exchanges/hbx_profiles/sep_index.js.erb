set_tab_content("<%= escape_javascript render "sep/index"%>")
$('.sep_link').hide();
$('.admin_effective_on_kind_options').hide();
$('.init_event_date').hide();


$(document).on('change','.admin_selected_sep_reason select',function(){  
  if($(this).val() == '') {
   $('.init_event_date').hide();    
   $('.admin_effective_on_kind_options').hide();
  }
  else{
   $('.init_event_date input').val("");
   $('.init_event_date').show();
   $('.admin_effective_on_kind_options').hide();
  }
});

$(document).on('change','.init_event_date input', function(){
  if($(this).val() == ''){
   $('.admin_effective_on_kind_options').hide(); 
  }
  else{
   $('.admin_effective_on_kind_options select').val('');
   $('.admin_effective_on_kind_options').show();
   $('select.selectric').selectric();

   $('input.floatlabel').floatlabel({
      slideInput: false
   });
  }  
});

var ivlTable, shopTable, ivl_shop_Table, selectedTable;

$(document).ready(function() {

  ivl_shop_Table = $('#sepAdmin').DataTable( {
      columnDefs: [
        { targets: [6,7], orderable: false},
        { targets: [8, 9, 10, 11, 12, 13, 14, 15, 16], visible: false}
      ],

      "order": [[ 2, "asc" ]]
    } );
   
  ivlTable = $('#sepAdmin1').DataTable( {
      columnDefs: [
        { targets: [6,7], orderable: false},
        { targets: [8, 9, 10, 11, 12, 13, 14, 15, 16], visible: false}
      ],

      "order": [[ 2, "asc" ]]
    } );

  shopTable = $('#sepAdmin2').DataTable( {
      columnDefs: [
        { targets: [6,7], orderable: false},
        { targets: [8, 9, 10, 11, 12, 13, 14, 15, 16], visible: false}
      ],

      "order": [[ 2, "asc" ]]
    } );

    selectedTable = ivl_shop_Table;

    $( '#tab_datatables a[data-toggle="tab"]:last').trigger("click");
    $( '#tab_datatables a[data-toggle="tab"]:first').trigger("click");

    $('#tab_datatables a[data-toggle="tab"]').on("click", function(){

    switch($(this).attr('data-target')) {
      case '#ivl_shop_Table':   
        selectedTable = ivl_shop_Table; 
        break;
      case '#ivlTable':
        selectedTable = ivlTable;
        break;
      case '#shopTable':   
        selectedTable = shopTable; 
        break;
      }
    });
} );

$('.sep_table tbody').on('click', 'td.add-control', function () {
  var btn_class = $(this).attr("class");
  var tr = $(this).closest('tr');
  var row = selectedTable.row(tr);
  var builder = row.data()[10];

  if (row.child.isShown() ) {
    $(this).removeClass('fa fa-minus-square');
    $(this).find('i').addClass('fa fa-plus-square');
    $('td.history-control').prop('disabled', false);
    $('td.history-control').removeClass('icon_disabled');
    $('td.history-control').addClass('icon_enabled');
    $('td.history-control').css("cursor", "pointer");

    $('div.add_sep_datatable_slider', row.child()).slideUp( function () {
    row.child.hide();
  } );
  }
  
  else {
    $(this).find('i').removeClass('fa fa-plus-square');
    $(this).addClass('fa fa-minus-square');
    $('td.history-control').prop('disabled', true);
    $('td.history-control').removeClass('icon_enabled');
    $('td.history-control').addClass('icon_disabled');
    $('td.history-control').css("cursor", "default");

  //Open this row
    row.child(displayTable(builder, btn_class, ""), 'no-padding' ).show();
    $('select.selectric').selectric();
    $('input.floatlabel').floatlabel({
      slideInput: false
    });

    $('select.floatlabel').floatlabel({
      slideInput: false
    });

    $('div.add_sep_datatable_slider', row.child()).slideDown();
  //}
  }  
});
 
 $('.sep_table tbody').on('click', 'td.history-control', function () {
  var btn_class = $(this).attr("class");
  var tr = $(this).closest('tr');
  var row = selectedTable.row(tr)
  var reason_arr = row.data()[8];
  var admin_comment_arr = row.data()[9];
  var fullName = row.data()[1] + " " + row.data()[2];
  var csl_arr = row.data()[11];
  var effective_on_kind_arr = row.data()[12];
  var start_on_arr = row.data()[13];
  var end_on_arr = row.data()[14];
  var event_date_arr = row.data()[15];
  var next_poss_date_arr = row.data()[16];

  var reason = reason_arr.split("?dummyData");
  var csl = csl_arr.split("?dummyData");
  var start_on = start_on_arr.split("?dummyData");
  var end_on = end_on_arr.split("?dummyData");
  var effective_on_kind = effective_on_kind_arr.split("?dummyData");
  var admin_comment = admin_comment_arr.split("?dummyData");
  var event_date = event_date_arr.split("?dummyData");
  var next_poss_date = next_poss_date_arr.split("?dummyData");

  var builder = buildTable(reason.length-1, reason, admin_comment, csl, effective_on_kind, start_on, end_on, event_date, next_poss_date);

  if ( row.child.isShown() ) {
    $(this).removeClass('fa fa-folder-open');
    $(this).find('i').addClass('fa fa-folder');
    $('td.add-control').prop('disabled', false);
    $('td.add-control').removeClass('icon_disabled');
    $('td.add-control').addClass('icon_enabled');
    $('td.add-control').css("cursor", "pointer");
  // This row is already open - close it
    $('div.add_sep_datatable_slider', row.child()).slideUp( function () {
    row.child.hide();

    $('.admin_effective_on_kind_options').hide();
    //tr.removeClass('shown');
    } );
  }
  
  else {
    $(this).find('i').removeClass('fa fa-folder');
    $(this).addClass('fa fa-folder-open');
    $('td.add-control').prop('disabled', true);
    $('td.add-control').removeClass('icon_enabled');
    $('td.add-control').addClass('icon_disabled');
    $('td.add-control').css("cursor", "default");

  // Open this row
    row.child(displayTable(builder, btn_class, fullName), 'no-padding' ).show();
    $('select.selectric').selectric();

    $('div.add_sep_datatable_slider', row.child()).slideDown();
  }
  }
);


function displayTable(custom_table, className, name) {

    if (className == 'add-control'){

      return '<div class="add_sep_datatable_slider" style="display:none">'+
            '<div class="row container">' +
            custom_table + 
            '<br/>'+
            '</div>' +
            '</div>';
    }

    else {

      return '<br/>' + '<br/>' + 
              '<div class="add_sep_datatable_slider" style="display:none">'+
              '<h3>' + name + '</h3>' +
  
              '<table class = "table table-striped table-bordered">'+
                    custom_table + 
              '</table>'+
              '<br/>'+ 
            '</div>';
    }
}


 function buildTable(size, reason, admin_comment, csl, effective_on_kind, start_on, end_on, event_date, next_poss_date)
 {
    var val = "";
    var comment_section;

    for(i=size-1; i>=0; i--){

      if(admin_comment[i] == "")
        comment_section = 'Admin Comment: N/A';
      else
        comment_section = 'Admin Comment: ' + admin_comment[i];

      val =   val + 
                '<tr>'+
                '<th>SEP REASON</th>'+ 
                '<th>EFFECTIVE DATE RULE</th>'+ 
                '<th>EVENT DATE</th>'+
                '<th>START DATE</th>'+
                '<th>END DATE</th>'+
                '<th>NEXT POSSIBLE EVENT DATE</th>'+
                //'<th>CHOICE DATE 1</th>'+
                //'<th>CHOICE DATE 2</th>'+
                //'<th>CHOICE DATE 3</th>'+
                '<th>CSL#</th>'+
                //'<th>Selected Date</th>'+
                //'<th>Effective Date</th>'+
                //'<th>Selected Date</th>'+
                //'<th>Effective Date</th>'+
                //'<th style="text-align:center";>Review Status</th>'+
                '</tr>'+
              '</thead>'+
        
              '<tbody>'+
                '<tr>'+
                  '<td>' + reason[i] + '</td>'+
                  '<td>' + effective_on_kind[i].replace(/_/g, " ") + '</td>'+
                  '<td>' + event_date[i] + '</td>'+
                  '<td>' + start_on[i] + '</td>'+
                  '<td>' + end_on[i] + '</td>'+
                  '<td>' + next_poss_date[i] + '</td>'+
                  '<td>' + csl[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td>' + reason[i] + '</td>'+
                  //'<td></td>'+
                  //'<td style="text-align:center";><i class="fa fa-spinner fa-spin" style="color:grey"></i></td>'+
                '</tr>'+ 

                '<tr>' +
                   '<td>&nbsp;&nbsp;' + comment_section + '</td>' +
                '</tr>'+
              '</tbody>' 
    }

    return val;
 }


 $(".btn").click(function() {
    if($("#collapseme").hasClass("out")) {
        $("#collapseme").addClass("in");
        $("#collapseme").removeClass("out");
    } else {
        $("#collapseme").addClass("out");
        $("#collapseme").removeClass("in");
    }
});


