<% content_for :horizontal_status do %>
  <%= render :partial => 'insured/families/horizontal_status.html.erb', locals: {step: 1} %>
<% end %>
<div class="container group-selection">
  <div class="row">
    <%= form_tag(:insured_group_selections, :id => "group-selection-form") do %>
      <div class="col-xs-8">
        <h1 class="darkblue">Choose Coverage for your Household</h1>
        <h4>Select who needs coverage and the type of coverage needed. When youâ€™re finished, select CONTINUE.</h4>
        <h3>Who Needs Coverage?</h3>
        <%= hidden_field_tag(:person_id, @person.id) %>
        <%= hidden_field_tag(:employee_role_id, @employee_role.id) if @employee_role %>
        <%= hidden_field_tag(:coverage_household_id, @coverage_household_id) %>
        <%= hidden_field_tag(:enrollment_kind, @enrollment_kind) %>
        <%= hidden_field_tag(:hbx_enrollment_id, @hbx_enrollment.id) if @hbx_enrollment.present? %>

        <%= render "shop_coverage_household" if can_shop_shop?(@person) %>

        <%= render 'ivl_coverage_household' if can_shop_individual?(@person) %>

        <% if can_shop_both_markets?(@person) %>
          <%= render "market_kinds" %>
        <% else %>
          <%= hidden_field_tag 'market_kind', group_selection_market_kind(@person, @market_kind) %>
        <% end %>

        <% if @employee_role.present? %>
          <h3>Employer: <%= @employee_role.employer_profile.legal_name %></h3>
        <% end %>

        <%= render 'coverall_coverage_household' if can_shop_resident?(@person) %>

        <div id="coverage_kinds" class='row no-buffer'>
          <h3>Benefit Type</h3>

          <div class="n-radio-group">
            <div class="n-radio-row">
              <%= benefit_type_radio(:health) %>
            </div>

            <div id="dental-radio-button" class="n-radio-row <%= 'dn' if can_shop_shop?(@person) && !@employee_role.is_dental_offered? %>">
              <%= benefit_type_radio(:dental) %>
            </div>
          </div>
        </div>

        <% if @market_kind == 'individual' && is_under_open_enrollment? %>
          <% if @change_plan.blank? && @enrollment_kind.blank?%>
            <div class='row top-pd'>
              <div class="col-sm-12">
                <p>If you enroll today, coverage will begin <%= format_date ivl_enrollment_effective_date %>. </p>
                <p>Do you need coverage earlier? See if you qualify for a <%= link_to "Special Enrollment Period", "#", :id => 'find_sep_link' %></p>
              </div>
            </div>
          <% end %>
          <% if @show_residency_alert && !CuramUser.name_in_curam_list(@person.first_name, @person.last_name) %>
            <div class='row top-pd'>
              <div class="col-sm-12">
                <p>Since <%= @person.full_name %> is not a resident of the <%= Settings.aca.state_name %> she/he is not eligible to purchase a plan through <%= Settings.site.short_name %>. Other members may still be eligible to enroll. Please call us at <%= Settings.contact_center.phone_number %> to learn about other health insurance options for <%= @person.full_name %>.</p>
              </div>
            </div>
          <% end %>
        <% end %>

        <%= render "actions" %>

        <br/>
        <br/>
        <%= link_to "Back to my account", family_account_path, class: 'btn btn-default btn btn-lg' %>
      </div>
      <%= render "progress_section" %>
    <% end %>
  </div>
  <%= render :partial => "insured/plan_shoppings/waive_confirmation", :locals => {:enrollment => @hbx_enrollment } if (@hbx_enrollment.present? && (@hbx_enrollment.employee_role.present? || @hbx_enrollment.benefit_group.present?)) %>
</div>
<script>
  $(function(){
    if ( $("#find_sep_link").length ) {
      $("#find_sep_link").click(function() {
      $(this).closest('form').attr('action', '<%= find_sep_insured_families_path %>');
      $(this).closest('form').attr('method', 'get');
      $(this).closest('form').submit();
    });
  }
})


function setGroupSelectionHandlers(){
  $('.group-selection-table .dental input').removeProp('checked');

  if ( $('#market_kind_shop').is(':checked') ) {
    $("#coverage_kind_health").prop("checked", true);
    $("#ivl-coverage-household input[type=checkbox]").prop("checked", false);
  }

<% if can_shop_both_markets?(@person) %>
  <% if @market_kind == 'individual' %>
    $('#market_kind_individual').prop("checked", true);
    $('#dental-radio-button').show();
  <% end %>

  $('#market_kind_shop').on('change', function() {
    <% if @employee_role.census_employee.active_benefit_group.blank? || !@employee_role.census_employee.active_benefit_group.is_offering_dental? %>
      $('#dental-radio-button').slideUp();
    <% end %>
    $('#shop-coverage-household').show();
    $('#ivl-coverage-household').hide();
    $('#ivl-coverage-household input').removeProp('checked');

    if ($('#coverage_kind_health').is(':checked')) {
      $('#shop-coverage-household .health tr').not(".ineligible_row").find('input').prop('checked', 'checked');
    }
    if ($('#coverage_kind_dental').is(':checked')) {
      $('#shop-coverage-household .dental tr').not(".ineligible_row").find('input').prop('checked', 'checked');
    }
  });

  $('#market_kind_individual').on('change', function() {
    $('#dental-radio-button').slideDown();
    $('#ivl-coverage-household').show();
    $('#shop-coverage-household').hide();
    $('#shop-coverage-household input').removeProp('checked');
    $('#ivl-coverage-household tr').not(".ineligible_row").find('input').prop('checked', 'checked');
  });
<% end %>

<% if (can_shop_shop?(@person) || can_shop_both_markets?(@person)) && @employee_role.census_employee.active_benefit_group.present? && @employee_role.census_employee.active_benefit_group.is_offering_dental? %>

  $('#coverage_kind_health').on('change', function() {
    $('#shop-coverage-household .health').show();
    $('#shop-coverage-household .health tr').not(".ineligible_row").find('input').prop('checked', 'checked');
    $('#shop-coverage-household .dental').hide();
    $('#shop-coverage-household .dental input').removeProp('checked');
  });

  $('#coverage_kind_dental').on('change', function() {
    $('#shop-coverage-household .dental').show();
    $('#shop-coverage-household .dental tr').not(".ineligible_row").find('input').prop('checked', 'checked');
    $('#shop-coverage-household .health').hide();
    $('#shop-coverage-household .health input').removeProp('checked');
  });
<% end %>

$("input[type='checkbox']").change(function() {
  if ($("#coverage_kind_health").is(":checked")){
    if($(this).is(":checked")) {
      $(this).attr( "checked", true );
    }else{
      $(this).removeProp('checked');
      $('#shop-coverage-household .dental input').removeProp('checked');
      }
    }
});
}

$(document).ready(function() {
 setGroupSelectionHandlers();
});

</script>
